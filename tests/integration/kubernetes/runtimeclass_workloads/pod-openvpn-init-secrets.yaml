#
# Copyright (c) 2025 Microsoft Corporation
#
# SPDX-License-Identifier: Apache-2.0
#
apiVersion: v1
kind: Pod
metadata:
  name: openvpn-init-secrets
spec:
  initContainers:
  - name: openvpn-init
    image: kylemanna/openvpn
    command: ["/bin/sh", "-c"]
    args:
      - |
        set -e
        WORKDIR="/etc/openvpn"
        CLIENT_NAME="client1"
        mkdir -p $WORKDIR
        ovpn_genconfig -u udp://your.openvpn.server
        EASYRSA_BATCH=1 ovpn_initpki nopass
        EASYRSA_BATCH=1 easyrsa build-server-full server nopass
        EASYRSA_BATCH=1 easyrsa build-client-full $CLIENT_NAME nopass

        base64 $WORKDIR/pki/ca.crt > $WORKDIR/ca.crt.b64
        base64 $WORKDIR/pki/issued/${CLIENT_NAME}.crt > $WORKDIR/client.crt.b64
        base64 $WORKDIR/pki/private/${CLIENT_NAME}.key > $WORKDIR/client.key.b64
        base64 $WORKDIR/pki/issued/server.crt > $WORKDIR/server.crt.b64
        base64 $WORKDIR/pki/private/server.key > $WORKDIR/server.key.b64
        base64 $WORKDIR/pki/dh.pem > $WORKDIR/dh.pem.b64
    volumeMounts:
    - name: openvpn-data
      mountPath: /etc/openvpn
  containers:
  - name: keepalive
    image: busybox
    command: ["sleep", "infinity"]
    volumeMounts:
    - name: openvpn-data
      mountPath: /etc/openvpn
  volumes:
  - name: openvpn-data
    emptyDir: {}
